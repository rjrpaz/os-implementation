<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="project0_files/filelist.xml">
<title>CMSC 412, Spring 2010</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>hollings</o:Author>
  <o:LastAuthor>hollings</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>138</o:TotalTime>
  <o:LastPrinted>2010-01-26T16:58:00Z</o:LastPrinted>
  <o:Created>2010-01-26T22:01:00Z</o:Created>
  <o:LastSaved>2010-01-26T22:01:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>1698</o:Words>
  <o:Characters>9684</o:Characters>
  <o:Company>University of Maryland</o:Company>
  <o:Lines>80</o:Lines>
  <o:Paragraphs>22</o:Paragraphs>
  <o:CharactersWithSpaces>11360</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:SelectEntireFieldWithStartOrEnd/>
   <w:UseWord2002TableStyleRules/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:"MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;
	mso-font-alt:"Arial Unicode MS";
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:"\@MS Mincho";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0pt;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"MS Mincho";}
h1
	{mso-margin-top-alt:auto;
	margin-right:0pt;
	mso-margin-bottom-alt:auto;
	margin-left:0pt;
	mso-pagination:widow-orphan;
	mso-outline-level:1;
	font-size:24.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h2
	{mso-margin-top-alt:auto;
	margin-right:0pt;
	mso-margin-bottom-alt:auto;
	margin-left:0pt;
	mso-pagination:widow-orphan;
	mso-outline-level:2;
	font-size:18.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h3
	{mso-margin-top-alt:auto;
	margin-right:0pt;
	mso-margin-bottom-alt:auto;
	margin-left:0pt;
	mso-pagination:widow-orphan;
	mso-outline-level:3;
	font-size:13.5pt;
	font-family:"Times New Roman";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-margin-top-alt:auto;
	margin-right:0pt;
	mso-margin-bottom-alt:auto;
	margin-left:0pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"MS Mincho";}
pre
	{margin:0pt;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"MS Mincho";}
tt
	{font-family:"Courier New";
	mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"MS Mincho";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Courier New";}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:612.0pt 792.0pt;
	margin:72.0pt 36.0pt 72.0pt 36.0pt;
	mso-header-margin:36.0pt;
	mso-footer-margin:36.0pt;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:130948927;
	mso-list-template-ids:-1153809320;}
@list l0:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:36.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1
	{mso-list-id:536158335;
	mso-list-template-ids:-1068485160;}
@list l1:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:36.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l2
	{mso-list-id:665980083;
	mso-list-template-ids:-1293646410;}
@list l2:level1
	{mso-level-tab-stop:36.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;}
@list l3
	{mso-list-id:1150556051;
	mso-list-template-ids:440196290;}
@list l3:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:36.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l3:level2
	{mso-level-number-format:bullet;
	mso-level-text:o;
	mso-level-tab-stop:72.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:"Courier New";
	mso-bidi-font-family:"Times New Roman";}
@list l4
	{mso-list-id:1173034665;
	mso-list-template-ids:-120530268;}
@list l4:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:36.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
ol
	{margin-bottom:0pt;}
ul
	{margin-bottom:0pt;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0pt 5.4pt 0pt 5.4pt;
	mso-para-margin:0pt;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
table.MsoTableGrid
	{mso-style-name:"Table Grid";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	border:solid windowtext 1.0pt;
	mso-border-alt:solid windowtext .5pt;
	mso-padding-alt:0pt 5.4pt 0pt 5.4pt;
	mso-border-insideh:.5pt solid windowtext;
	mso-border-insidev:.5pt solid windowtext;
	mso-para-margin:0pt;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=purple style='tab-interval:36.0pt'>

<div class=Section1>

<h1 align=center style='margin:0pt;margin-bottom:.0001pt;text-align:center'><span
style='font-size:12.0pt;font-weight:normal'>CMSC 412, <span class=GramE>Spring</span>
2010<o:p></o:p></span></h1>

<h1 align=center style='margin:0pt;margin-bottom:.0001pt;text-align:center'><span
style='font-size:14.0pt'>Project 0<br>
Due: Friday, February 5th, 2010 6:00 pm<o:p></o:p></span></h1>

<ul type=disc>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l3 level1 lfo1;tab-stops:list 36.0pt'>Download Project Source: <br>
     <span class=SpellE><tt><span style='font-size:10.0pt'>svn</span></tt></span><tt><span
     style='font-size:10.0pt'> co <a
     href="https://svn.cs.umd.edu/repos/geekos/project0">https://svn.cs.umd.edu/repos/geekos/project0</a></span></tt>
     </li>
 <ul type=circle>
  <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:
      auto;mso-list:l3 level2 lfo1;tab-stops:list 72.0pt'><span class=GramE>your</span>
      username is <span class=SpellE>sv-geekosro</span> with a blank password. </li>
 </ul>
</ul>

<p style='margin-left:36.0pt;text-indent:-18.0pt;mso-list:l3 level1 lfo1;
tab-stops:list 36.0pt'><![if !supportLists]><span style='font-size:10.0pt;
mso-bidi-font-size:12.0pt;font-family:Symbol;mso-fareast-font-family:Symbol;
mso-bidi-font-family:Symbol'><span style='mso-list:Ignore'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span dir=LTR><a
href="http://www.cs.umd.edu/class/spring2010/cmsc412/project0/submit.html">Submission
Instructions</a></span></p>

<h2><span style='font-size:14.0pt'>Introduction<o:p></o:p></span></h2>

<p><span style='font-size:10.0pt'>In this course we will implement a big
project in subsequent phases. In each project we will be adding some new
functionality to <a href="http://geekos.sourceforge.net/"><span class=SpellE>GeekOS</span></a>.
<span class=SpellE>GeekOS</span> is a tiny operating system kernel for x86 PCs.
Its main purpose is to serve as a simple but realistic example of an OS kernel
running on <a href="http://geekos.sourceforge.net/hardware.html">real hardware</a>.
To run our OS, we need to either use an actual machine (which must be an x86
machine) or the other (simpler) idea is to use an emulator; we will use <a
href="http://www.qemu.org/index.html">QEMU</a>.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt'>The purpose of this assignment (project0) is
to get you familiar with the <span class=SpellE>GeekOS</span> development
environment, including the QEMU <span class=GramE>x86 emulator</span> and the
debugger <span class=SpellE>gdb</span>. The assignment is to modify <span
class=SpellE>GeekOS</span> to impose resource limits on <span class=SpellE>GeekOS</span>
processes in two simple ways: <o:p></o:p></span></p>

<ul type=disc>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l4 level1 lfo2;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Only permit N user processes from being active at any given time
     (for some given N). An attempt to <span class=GramE>Spawn</span> the N+1st
     process will result in failure. <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l4 level1 lfo2;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Only permit a given user process from performing M system calls
     (for some given M). When a process attempts to perform the M+1st system call,
     it should exit (i.e., the M+1st system call should be treated as an Exit
     system call). <o:p></o:p></span></li>
</ul>

<h2><span style='font-size:14.0pt'>Background<o:p></o:p></span></h2>

<h3>Running <span class=SpellE>GeekOS</span></h3>

<p class=MsoNormal><span style='font-size:10.0pt'>To compile <span
class=SpellE>GeekOS</span>, <span class=SpellE>untar</span> the project source,
change your directory to build, and execute </span><tt><span style='font-size:
10.0pt'>make</span></tt><span style='font-size:10.0pt'>. To run the OS in the
emulator execute </span><tt><span style='font-size:10.0pt'>make run</span></tt><span
style='font-size:10.0pt'>. <br>
<br>
Once you have started up <span class=SpellE>GeekOS</span>, you will be taken to
the <span class=SpellE>GeekOS</span> shell prompt.&nbsp; That is, the first
program that <span class=SpellE>GeekOS</span> runs is shell.exe, which takes
commands for you to run just like the UNIX shell program.&nbsp; The <span
class=SpellE>GeekOS</span> file system is set up so that a number of user
programs are installed in the directory </span><span style='font-size:10.0pt;
font-family:"Courier New"'>/c</span><span style='font-size:10.0pt'>.&nbsp; The
source code for these programs is in the directory </span><span class=SpellE><span
style='font-size:10.0pt;font-family:"Courier New"'>src</span></span><span
style='font-size:10.0pt;font-family:"Courier New"'>/user</span><span
style='font-size:10.0pt'> in the distribution.&nbsp; The programs </span><span
style='font-size:10.0pt;font-family:"Courier New"'>b.exe</span><span
style='font-size:10.0pt'>, </span><span style='font-size:10.0pt;font-family:
"Courier New"'>null.exe</span><span style='font-size:10.0pt'>, and </span><span
style='font-size:10.0pt;font-family:"Courier New"'>long.exe</span><span
style='font-size:10.0pt'> are three such programs.&nbsp; The first program
simply prints all of its arguments.&nbsp; The second is an infinite loop.&nbsp;
The third is a long, but not infinite loop.&nbsp; You can run the programs as
you would expect. For example, to run the </span><span style='font-size:10.0pt;
font-family:"Courier New"'>b.exe</span><span style='font-size:10.0pt'> program,
you could do <o:p></o:p></span></p>

<pre><span style='mso-spacerun:yes'>     </span>$ /c/b.exe 1 2 3 4</pre>

<p class=MsoNormal style='margin-bottom:12.0pt'><span style='font-size:10.0pt'>And
it would print out the four arguments that you provided. The shell also takes a
number of directives.&nbsp; For example, typing </span><span style='font-size:
10.0pt;font-family:"Courier New"'>exit</span><span style='font-size:10.0pt'>
will terminate the shell (and your interaction with the OS).&nbsp; Look at </span><span
class=SpellE><span style='font-size:10.0pt;font-family:"Courier New"'>src/user/shell.c</span></span><span
style='font-size:10.0pt'> to understand the other features of the shell.<br>
</span><br>
<span style='font-size:10.0pt'>You can easily add your own user programs by
adding a file to </span><span class=SpellE><span style='font-size:10.0pt;
font-family:"Courier New"'>src</span></span><span style='font-size:10.0pt;
font-family:"Courier New"'>/user</span><span style='font-size:10.0pt'>.<o:p></o:p></span></p>

<h3>Debugging <span class=SpellE>GeekOS</span></h3>

<p class=MsoNormal><span style='font-size:10.0pt'>Start the emulator in debug
mode with </span><tt><span style='font-size:10.0pt'>make <span class=SpellE>dbgrun</span></span></tt><span
style='font-size:10.0pt'>, then in another terminal run <span class=SpellE>gdb</span>
with </span><tt><span style='font-size:10.0pt'>make <span class=SpellE>dbg</span></span></tt><span
style='font-size:10.0pt'>; the debugger will attach to the operating system.
The symbols for user programs will not be loaded. We will fix this problem for
project 1. In debug mode the system starts paused, so you can enter breakpoints
before execution. To begin execution enter </span><tt><span style='font-size:
10.0pt'>continue</span></tt><span style='font-size:10.0pt'> into the debugger. <br>
<br>
Now we'll talk about how <span class=SpellE>GeekOS</span> works.<o:p></o:p></span></p>

<h3>User processes vs. the kernel processes</h3>

<p><span style='font-size:10.0pt'>In writing an operating system, you want to
make a distinction between the activities that operating systems code are
allowed to do and the activities user programs are allowed to do. The goal is
to protect the system from incorrect or malicious code that a user may try to
run. Bad things a program could do include:<o:p></o:p></span></p>

<ul type=disc>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo3;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Making the operating system and/or other user programs crash <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo3;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Looking at data that belong to the system or to other programs <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo3;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Circumventing access control <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo3;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Using hardware incorrectly, with all the negative consequences
     that result e.g. machine crash or data corruption <o:p></o:p></span></li>
</ul>

<p><span style='font-size:10.0pt'>Preventing these sorts of mistakes or attacks
is accomplished by controlling the parts of memory that can be accessed when
user code is running and limiting the set of machine operations that the user
code can execute. <span class=GramE>The x86 processor</span> provides the
operating system with facilities to support these controls. A program that is
running in this sort of controlled way is said to be running in <em>user mode</em>.
<o:p></o:p></span></p>

<h3>Anatomy of a User Process</h3>

<p><span style='font-size:10.0pt'>In <span class=SpellE>GeekOS</span>, there is
a distinction between <b>Kernel Threads</b> and <b>User Threads</b>. As you
would expect, kernel activities (that is, <em>processes</em>) run as kernel
threads, while user programs (or rather, user processes) run in user threads. A
kernel thread is represented by a </span><span class=SpellE><tt><span
style='font-size:10.0pt'>Kernel_Thread</span></tt></span><span
style='font-size:10.0pt'> structure (in </span><tt><span style='font-size:10.0pt'>include/<span
class=SpellE>geekos/kthread.h</span></span></tt><span style='font-size:10.0pt'>)<o:p></o:p></span></p>

<pre><tt><o:p>&nbsp;</o:p></tt></pre><pre><span class=SpellE><span class=GramE><tt>struct</tt></span></span><tt> <span
class=SpellE>Kernel_Thread</span> {<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>ulong_t</span></span> <span class=SpellE>esp</span>;<span style='mso-spacerun:yes'>                         </span>/* offset 0 */<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=GramE>volatile</span> <span class=SpellE>ulong_t</span> <span
class=SpellE>numTicks</span>;<span style='mso-spacerun:yes'>           </span>/* offset 4 */<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>int</span></span> priority;<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span>DEFINE_<span
class=GramE>LINK(</span><span class=SpellE>Thread_Queue</span>, <span
class=SpellE>Kernel_Thread</span>);<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=GramE>void</span>* <span class=SpellE>stackPage</span>;<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>User_Context</span>* <span
class=SpellE>userContext</span>;<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>Kernel_Thread</span>* owner;<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>int</span></span> <span class=SpellE>refCount</span>;<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>  </span>...<o:p></o:p></tt></pre><pre><tt>}<o:p></o:p></tt></pre>

<p><span style='font-size:10.0pt'>The kernel thread contains all of the
mechanisms necessary to run and schedule a process. In order to represent user
processes, <span class=SpellE>GeekOS</span> includes an extra field in the <span
class=SpellE><tt><span style='font-family:"Times New Roman"'>Kernel_Thread</span></tt></span>
structure that points to a <span class=SpellE><tt><span style='font-family:
"Times New Roman"'>User_Context</span></tt></span> structure. In a thread
representing a kernel process, the <span class=SpellE><tt><span
style='font-family:"Times New Roman"'>User_Context</span></tt></span> will be <tt><span
style='font-family:"Times New Roman"'>NULL</span></tt>. The <span class=SpellE><tt><span
style='font-family:"Times New Roman"'>User_Context</span></tt></span> is
defined in <tt><span style='font-family:"Times New Roman"'>include/<span
class=SpellE>geekos/user.h</span></span></tt>: <tt><span style='font-family:
"Times New Roman"'><o:p></o:p></span></tt></span></p>

<pre><span class=SpellE><span class=GramE><tt>struct</tt></span></span><tt> <span
class=SpellE>User_Context</span> {<o:p></o:p></tt></pre><pre><tt> <span style='mso-spacerun:yes'>   </span>/* <span
class=GramE>We</span> need one LDT entry each for user code and data segments. */<o:p></o:p></tt></pre><pre><tt>#define NUM_USER_LDT_ENTRIES 2<o:p></o:p></tt></pre><pre><tt><o:p>&nbsp;</o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span>/*<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>     </span>* Each user context contains a local descriptor table with<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>     </span>* <span
class=GramE>just</span> enough room for one code and one data segment<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>     </span>* describing the process's memory.<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>     </span>*/<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>Segment_Descriptor</span> <span
class=SpellE>ldt</span>[NUM_USER_LDT_ENTRIES];<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>Segment_Descriptor</span>* <span
class=SpellE>ldtDescriptor</span>;<o:p></o:p></tt></pre><pre><tt><o:p>&nbsp;</o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span>/* <span
class=GramE>The</span> memory space used by the process. */<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=GramE>char</span>* memory;<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>ulong_t</span></span> size;<o:p></o:p></tt></pre><pre><tt><o:p>&nbsp;</o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span>/* Selector for the <span
class=SpellE>LDT's</span> descriptor in the GDT */<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>    </span><span
class=SpellE><span class=GramE>ushort_t</span></span> <span class=SpellE>ldtSelector</span>;<o:p></o:p></tt></pre><pre><tt><span style='mso-spacerun:yes'>   </span>...<o:p></o:p></tt></pre><pre><tt>};</tt></pre>

<p><span style='font-size:10.0pt'>Most of the information in the </span><span
class=SpellE><tt><span style='font-size:10.0pt'>User_Context</span></tt></span><span
style='font-size:10.0pt'> structure has to do with the memory layout for the
process, and you don't need to understand that for now. You will have to modify
</span><span class=SpellE><tt><span style='font-size:10.0pt'>User_Context</span></tt></span><span
style='font-size:10.0pt'> to contain some bookkeeping information as part of
this project. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt'>User threads are created using the routine </span><span
class=SpellE><tt><span style='font-size:10.0pt'>Start_User_Thread</span></tt></span><span
style='font-size:10.0pt'>. This takes as its first argument the </span><span
class=SpellE><tt><span style='font-size:10.0pt'>User_Context</span></tt></span><span
style='font-size:10.0pt'> to run within that thread. This context is created by
the </span><span class=SpellE><tt><span style='font-size:10.0pt'>Sys_Spawn</span></tt></span><span
style='font-size:10.0pt'> <i>system call</i>. A system call is like a function
call that a user program makes to the OS kernel, to ask it to perform some
service. </span></p>

<h3>System Calls</h3>

<p><span style='font-size:10.0pt'>The operating system kernel presents an
interface to user processes for the services it will perform on their behalf.
These are essentially functions. However, rather than literally performing a
function call to access them, user processes have to use a special mechanism,
called a system call. System calls are designed to protect the kernel's memory
from malicious processes. On Intel's <span class=GramE>x86 processor,</span> a
user process issues a system call via a <i>trap</i>, which indicates that a
system call is being requested; the identity of the system call routine and/or
the arguments to pass to it are stored in the processor registers. This
mechanism is hidden from the typical C programmer, since it is typically used
only in the standard C library routines. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt'>In <span class=SpellE>GeekOS</span>, when a
user process issues a system call, the trap causes the routine </span><span
class=SpellE><tt><span style='font-size:10.0pt'>Syscall_Handler</span></tt></span><span
style='font-size:10.0pt'> in </span><span class=SpellE><tt><span
style='font-size:10.0pt'>geekos/trap.c</span></tt></span><span
style='font-size:10.0pt'> to be invoked. This routine examines the current value
in the register </span><span class=SpellE><tt><span style='font-size:10.0pt'>eax</span></tt></span><span
style='font-size:10.0pt'> and calls the appropriate system routine to handle
the <span class=SpellE>syscall</span> request. The value in </span><span
class=SpellE><tt><span style='font-size:10.0pt'>eax</span></tt></span><span
style='font-size:10.0pt'> is called the <span class=SpellE><b>Syscall</b></span><b>
Number</b>. The routine that handles the <span class=SpellE>syscall</span>
request is passed a copy of the caller's <i>context state</i>, so the values in
general registers (</span><span class=SpellE><tt><span style='font-size:10.0pt'>ebx</span></tt></span><tt><span
style='font-size:10.0pt'>, <span class=SpellE>ecx</span>, <span class=SpellE>edx</span></span></tt><span
style='font-size:10.0pt'>) can be used by the user program to pass parameters
to the handler routine and can be used to return values to the user program.
This state is defined in the <span class=SpellE>struct</span> </span><span
class=SpellE><tt><span style='font-size:10.0pt'>Interrupt_State</span></tt></span><span
style='font-size:10.0pt'>, defined in </span><span class=SpellE><tt><span
style='font-size:10.0pt'>geekos/int.h</span></tt></span><span style='font-size:
10.0pt'>. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt'>The routines that implement <span
class=SpellE>GeekOS</span> system calls are in </span><span class=SpellE><tt><span
style='font-size:10.0pt'>geekos/syscall.c</span></tt></span><span
style='font-size:10.0pt'>. The </span><span class=SpellE><tt><span
style='font-size:10.0pt'>Sys_Spawn</span></tt></span><span style='font-size:
10.0pt'> code is implemented here, along with code for other system calls, like
</span><span class=SpellE><tt><span style='font-size:10.0pt'>Sys_Exit</span></tt></span><span
style='font-size:10.0pt'> for the system call used by a process to terminate
itself. If you are curious how system calls are invoked from user processes,
take a look at </span><span class=SpellE><tt><span style='font-size:10.0pt'>src/user/shell.c</span></tt></span><span
style='font-size:10.0pt'> in your project distribution; you'll be modifying
this program in your next project.</span> </p>

<h3>Creating User Processes - <span class=SpellE>Sys_<span class=GramE>Spawn</span></span><span
class=GramE>()</span></h3>

<p><span style='font-size:10.0pt'>In order to create a user process, the </span><span
class=SpellE><tt><span style='font-size:10.0pt'>Sys_Spawn</span></tt></span><span
style='font-size:10.0pt'> <span class=SpellE>syscall</span> is used (defined in
</span><span class=SpellE><tt><span style='font-size:10.0pt'>geekos/syscall.c</span></tt></span><span
style='font-size:10.0pt'>). The function calls </span><span class=GramE><tt><span
style='font-size:10.0pt'>Spawn(</span></tt></span><tt><span style='font-size:
10.0pt'>)</span></tt><span style='font-size:10.0pt'> (defined in the file </span><span
class=SpellE><tt><span style='font-size:10.0pt'>src/geekos/user.c</span></tt></span><span
style='font-size:10.0pt'>) that is used to launch user programs. FYI, this </span><span
class=GramE><tt><span style='font-size:10.0pt'>Spawn(</span></tt></span><tt><span
style='font-size:10.0pt'>)</span></tt><span style='font-size:10.0pt'> function
does the following (see the comments in </span><span class=SpellE><tt><span
style='font-size:10.0pt'>user.c</span></tt></span><span style='font-size:10.0pt'>
as well) <o:p></o:p></span></p>

<ul type=disc>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l0 level1 lfo4;tab-stops:list 36.0pt'><span class=SpellE><tt><span
     style='font-size:10.0pt'>Read_Fully</span></tt></span><tt><span
     style='font-size:10.0pt'>()</span></tt><span style='font-size:10.0pt'>
     function to read an executable file from disk into memory <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l0 level1 lfo4;tab-stops:list 36.0pt'><span class=SpellE><tt><span
     style='font-size:10.0pt'>Parse_ELF_<span class=GramE>Executable</span></span></tt></span><span
     class=GramE><tt><span style='font-size:10.0pt'>(</span></tt></span><tt><span
     style='font-size:10.0pt'>)</span></tt><span style='font-size:10.0pt'>
     function to populate an </span><span class=SpellE><tt><span
     style='font-size:10.0pt'>Exe_Format</span></tt></span><span
     style='font-size:10.0pt'> data structure. <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l0 level1 lfo4;tab-stops:list 36.0pt'><span class=SpellE><tt><span
     style='font-size:10.0pt'>Load_User_Program</span></tt></span><tt><span
     style='font-size:10.0pt'>()</span></tt><span style='font-size:10.0pt'> to
     set up the memory image for the new process and create a </span><span
     class=SpellE><tt><span style='font-size:10.0pt'>User_Context</span></tt></span><span
     style='font-size:10.0pt'> with the loaded program <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l0 level1 lfo4;tab-stops:list 36.0pt'><span class=SpellE><tt><span
     style='font-size:10.0pt'>Start_User_Thread</span></tt></span><tt><span
     style='font-size:10.0pt'>()</span></tt><span style='font-size:10.0pt'>
     with the new </span><span class=SpellE><tt><span style='font-size:10.0pt'>User_Context</span></tt></span><span
     style='font-size:10.0pt'> <o:p></o:p></span></li>
</ul>

<p><span class=SpellE><tt><span style='font-size:10.0pt'>Sys_Spawn</span></tt></span><span
style='font-size:10.0pt'> returns the process id (<span class=SpellE><span
class=GramE>pid</span></span>) of the new thread. <o:p></o:p></span></p>

<h2><span style='font-size:14.0pt'>Project Requirements<o:p></o:p></span></h2>

<p><span style='font-size:10.0pt'>The purpose of this assignment is to modify <span
class=SpellE>GeekOS</span> to impose resource limits on <span class=SpellE>GeekOS</span>
processes in two simple ways: <o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l2 level1 lfo5;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Only permit <i>N</i> user processes from being active at any given
     time (for some <i>N</i>). <o:p></o:p></span></li>
 <li class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l2 level1 lfo5;tab-stops:list 36.0pt'><span style='font-size:
     10.0pt'>Only permit a user process to perform at most <i>M</i> system
     calls (for some <i>M</i>). <o:p></o:p></span></li>
</ol>

<p><b><span style='font-size:10.0pt'>For the purposes of the project, you can
fix N to be 10 and M to be 100</span></b><span style='font-size:10.0pt'>. That
is, just make global variables in </span><span class=SpellE><tt><span
style='font-size:10.0pt'>kthread.c</span></tt></span><span style='font-size:
10.0pt'> and initialize them to these values. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt'>Finally, you need to create a user-level
process that spawns some other process a desired number of times.</span> </p>

<h3>Limiting Number of Processes</h3>

<p><span style='font-size:10.0pt'>To limit the number of processes, you should
maintain a counter for the <i>current</i> number of (active) <b>user</b>
processes. Then you must determine whether a Spawn is allowed by checking the
value of the counter. Follow the code through the </span><span class=SpellE><tt><span
style='font-size:10.0pt'>Sys_Spawn</span></tt></span><span style='font-size:
10.0pt'> system call (defined in </span><span class=SpellE><tt><span
style='font-size:10.0pt'>geekos/syscall.c</span></tt></span><span
style='font-size:10.0pt'>) and make modifications as necessary in the kernel.
If the limit has been reached then the process should not be created and </span><span
class=SpellE><span style='font-size:10.0pt;font-family:"Courier New"'>Sys_Spawn</span></span><span
style='font-size:10.0pt'> should fail by returning -1. <o:p></o:p></span></p>

<h3>Limiting Number of System Calls</h3>

<p><span style='font-size:10.0pt'>In order to limit the number of system calls,
you need to modify the </span><span class=SpellE><tt><span style='font-size:
10.0pt'>User_Context</span></tt></span><span style='font-size:10.0pt'>
structure (defined in </span><tt><span style='font-size:10.0pt'>include/<span
class=SpellE>geekos/user.h</span></span></tt><span style='font-size:10.0pt'>)
to include a counter for the number of system calls the user process has
performed. Then you should modify the kernel to update this counter each time
it performs a system call on this process's behalf.&nbsp; For the system call
that exceeds the limit (i.e., the N+1st system call), </span><span
class=SpellE><tt><span style='font-size:10.0pt'>Sys_Exit</span></tt></span><span
style='font-size:10.0pt'> should be called instead to kill the process. <o:p></o:p></span></p>

<h3>Creating a user process to spawn a specified number of processes</h3>

<p><span style='font-size:10.0pt'>Look at the code provided in </span><span
class=SpellE><tt><span style='font-size:10.0pt'>src</span></tt></span><tt><span
style='font-size:10.0pt'>/user/*</span></tt><span style='font-size:10.0pt'> and
specifically at </span><span class=SpellE><tt><span style='font-size:10.0pt'>shell.c</span></tt></span><span
style='font-size:10.0pt'> to see how to spawn other processes using the system
call interface provided. Write a user-level process called </span><span
style='font-size:10.0pt;font-family:"Courier New"'>spawn.exe</span><span
style='font-size:10.0pt'> that takes as its argument the number <i>P</i> and
then spawns <i>P</i> processes.&nbsp; Spawn the provided user-level program </span><tt><b><span
style='font-size:10.0pt;color:red'>null.exe</span></b></tt><span
style='font-size:10.0pt'>. Your spawn.exe program should display an error
message &quot;Maximum number of processes reached&quot; if spawn fails due to
reaching the maximum number of spawned processes.<o:p></o:p></span></p>

<h2><span style='font-size:14.0pt'>Grading Criteria<o:p></o:p></span></h2>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none;mso-border-alt:solid windowtext .5pt;
 mso-yfti-tbllook:480;mso-padding-alt:0pt 5.4pt 0pt 5.4pt;mso-border-insideh:
 .5pt solid windowtext;mso-border-insidev:.5pt solid windowtext'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td valign=top style='border:solid windowtext 1.0pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2><span style='font-size:10.0pt;font-weight:normal'>Unpack and compile
  correctly and we can see that you've made a good effort at the project</span><span
  style='font-size:14.0pt;font-weight:normal'><o:p></o:p></span></h2>
  </td>
  <td valign=top style='border:solid windowtext 1.0pt;border-left:none;
  mso-border-left-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2 align=right style='text-align:right'><span style='font-size:10.0pt;
  font-weight:normal'>20</span><span style='font-size:14.0pt;font-weight:normal'><o:p></o:p></span></h2>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1'>
  <td valign=top style='border:solid windowtext 1.0pt;border-top:none;
  mso-border-top-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2><span style='font-size:10.0pt;font-weight:normal'>Limiting number of
  processes correctly</span><span style='font-size:14.0pt;font-weight:normal'><o:p></o:p></span></h2>
  </td>
  <td valign=top style='border-top:none;border-left:none;border-bottom:solid windowtext 1.0pt;
  border-right:solid windowtext 1.0pt;mso-border-top-alt:solid windowtext .5pt;
  mso-border-left-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2 align=right style='text-align:right'><span style='font-size:10.0pt;
  font-weight:normal'>30</span><span style='font-size:14.0pt;font-weight:normal'><o:p></o:p></span></h2>
  </td>
 </tr>
 <tr style='mso-yfti-irow:2'>
  <td valign=top style='border:solid windowtext 1.0pt;border-top:none;
  mso-border-top-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2><span style='font-size:10.0pt;font-weight:normal'>Limiting number of
  system calls correctly<o:p></o:p></span></h2>
  </td>
  <td valign=top style='border-top:none;border-left:none;border-bottom:solid windowtext 1.0pt;
  border-right:solid windowtext 1.0pt;mso-border-top-alt:solid windowtext .5pt;
  mso-border-left-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2 align=right style='text-align:right'><span style='font-size:10.0pt;
  font-weight:normal'>30<o:p></o:p></span></h2>
  </td>
 </tr>
 <tr style='mso-yfti-irow:3'>
  <td valign=top style='border:solid windowtext 1.0pt;border-top:none;
  mso-border-top-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2><span style='font-size:10.0pt;font-weight:normal'>Testing spawn.exe <i>P</i>
  (where <i>P</i> is the number of times to spawn null.exe)<o:p></o:p></span></h2>
  </td>
  <td valign=top style='border-top:none;border-left:none;border-bottom:solid windowtext 1.0pt;
  border-right:solid windowtext 1.0pt;mso-border-top-alt:solid windowtext .5pt;
  mso-border-left-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2 align=right style='text-align:right'><span style='font-size:10.0pt;
  font-weight:normal'>20<o:p></o:p></span></h2>
  </td>
 </tr>
 <tr style='mso-yfti-irow:4;mso-yfti-lastrow:yes'>
  <td valign=top style='border:solid windowtext 1.0pt;border-top:none;
  mso-border-top-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2><span style='font-size:10.0pt'>Total<o:p></o:p></span></h2>
  </td>
  <td valign=top style='border-top:none;border-left:none;border-bottom:solid windowtext 1.0pt;
  border-right:solid windowtext 1.0pt;mso-border-top-alt:solid windowtext .5pt;
  mso-border-left-alt:solid windowtext .5pt;mso-border-alt:solid windowtext .5pt;
  padding:0pt 5.4pt 0pt 5.4pt'>
  <h2 align=right style='text-align:right'><span style='font-size:10.0pt;
  font-weight:normal'>100<o:p></o:p></span></h2>
  </td>
 </tr>
</table>

</div>

<h2><o:p>&nbsp;</o:p></h2>

</div>

</body>

</html>
